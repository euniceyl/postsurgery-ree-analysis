---
title: "STA 440 Final Project: Code Script"
author: "Eunice Lee"
format: pdf
editor: visual
---

## Package Import & Data Cleaning
```{r}
library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
```

```{r}
load("REE.RData")
```

```{r}
REE <- REE %>%
  mutate(
    ID = factor(ID),
    Obese = factor(Obese, levels = c(0, 1)),
    Ventilator = factor(Ventilator, levels = c(0, 1)),
    ICUorSDU   = factor(ICUorSDU, levels = c("ICU", "SDU")),
    Measurement = as.numeric(Measurement)
  )
```

## EDA
```{r}
# Histogram of REE
ggplot(REE, aes(x = REE)) +
  geom_histogram(fill = "skyblue", color = "black") +
  labs(title = "Distribution of REE") +
  theme_bw()

# Histogram of REE/kg
ggplot(REE, aes(x = REEperKG)) +
  geom_histogram(fill = "lightgreen", color = "black") +
  labs(title = "Distribution of REE per kg") +
  theme_bw()
```
```{r}
ggplot(REE, aes(x = Obese, y = REE)) +
  geom_boxplot(fill = "skyblue", color = "black") +
  labs(title = "REE by Obesity") +
  theme_bw()

ggplot(REE, aes(x = Obese, y = REEperKG)) +
  geom_boxplot(fill = "lightgreen", color = "black") +
  labs(title = "REE/kg by Obesity") +
  theme_bw()

ggplot(REE, aes(x = Ventilator, y = REE)) +
  geom_boxplot(fill = "skyblue", color = "black") +
  labs(title = "REE by Ventilator Use") +
  theme_bw()

ggplot(REE, aes(x = Ventilator, y = REEperKG)) +
  geom_boxplot(fill = "lightgreen", color = "black") +
  labs(title = "REE/kg by Ventilator Use") +
  theme_bw()

ggplot(REE, aes(x = ICUorSDU, y = REE)) +
  geom_boxplot(fill = "skyblue", color = "black") +
  labs(title = "REE by Location (ICU vs SDU)") +
  theme_bw()

ggplot(REE, aes(x = ICUorSDU, y = REEperKG)) +
  geom_boxplot(fill = "lightgreen", color = "black") +
  labs(title = "REE/kg by Location (ICU vs SDU)") +
  theme_bw()
```

```{r}
# Facet by patient: slope patterns
ggplot(REE, aes(x = Measurement, y = REEperKG)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ ID, scales = "free_y") +
  labs(title = "REE per kg over Time for Each Patient") +
  theme_bw()

# Patient trajectories (spaghetti plot)
ggplot(REE, aes(x = Measurement, y = REEperKG, group = ID, color = ID)) +
  geom_line() +
  geom_point() +
  labs(title = "Longitudinal REE/kg Trajectories by Patient") +
  theme_bw() +
  theme(legend.position = "right")
```
```{r}
# Boxplot by patient
ggplot(REE, aes(x = ID, y = REE)) +
  geom_boxplot(outlier.colour = "red") +
  labs(title = "REE by Patient") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Boxplot by patient
ggplot(REE, aes(x = ID, y = REEperKG)) +
  geom_boxplot(outlier.colour = "red") +
  labs(title = "REE/kg by Patient") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
# Proportion of Ventilation by Location
ggplot(REE, aes(x = ICUorSDU, fill = Ventilator)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(y = "Proportion", title = "Ventilator Use by Location") +
  theme_bw()
```
```{r}
# REE vs BMI
ggplot(REE, aes(x = BMI, y = REE)) +
  geom_point(size = 2) +
  geom_smooth(method = "lm", se = FALSE, colour = "black") +
  labs(title = "REE vs BMI") +
  theme_bw()

# REE/kg vs BMI
ggplot(REE, aes(x = BMI, y = REEperKG, colour = Obese)) +
  geom_point(size = 2) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed") +
  labs(title = "REE/kg vs BMI") +
  theme_bw()
```
## Initial Model
```{r}
library(lme4)
```
```{r}
model_REEperKG <- lmer(
  REEperKG ~ Obese * Measurement + ICUorSDU * Measurement + Ventilator + (1 | ID),
  data = REE
)

summary(model_REEperKG)
```
```{r}
ggplot(REE, aes(x = Measurement, y = REEperKG, color = Obese)) +
  geom_point(size = 2, alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE,
              aes(fill = Obese), alpha = 0.2) +
  facet_wrap(~ ICUorSDU) +
  labs(title = "REE per kg Over Recovery by Location",
       y = "REE/kg (kcal/kg/day)") +
  theme_bw() +
  theme(strip.background = element_rect(fill="grey90"),
        strip.text = element_text(size=11))
```
```{r}
ggplot(REE, aes(x = Measurement, y = REEperKG, color = ICUorSDU)) +
  geom_point(size = 2, alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE,
              aes(fill = ICUorSDU), alpha = 0.2) +
  facet_wrap(~ Obese) +
  labs(title = "REE per kg Over Recovery by Obesity Status",
       y = "REE/kg (kcal/kg/day)",
       color = "Location",
       fill = "Location") +
  theme_bw() +
  theme(strip.background = element_rect(fill="grey90"),
        strip.text = element_text(size=11))
```

```{r}
model_REE <- lmer(
  REE ~ Obese * Measurement + ICUorSDU * Measurement + Ventilator + (1 | ID),
  data = REE
)

summary(model_REE)
```
```{r}
ggplot(REE, aes(x = Measurement, y = REE, color = Obese)) +
  geom_point(size = 2, alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE,
              aes(fill = Obese), alpha = 0.2) +
  facet_wrap(~ ICUorSDU) +
  labs(title = "Absolute REE Over Recovery by Location",
       y = "REE (kcal/day)") +
  theme_bw() +
  theme(strip.background = element_rect(fill="grey90"),
        strip.text = element_text(size=11))
```
```{r}
ggplot(REE, aes(x = Measurement, y = REE, color = ICUorSDU)) +
  geom_point(size = 2, alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE,
              aes(fill = ICUorSDU), alpha = 0.2) +
  facet_wrap(~ Obese) +
  labs(title = "Absolute REE Over Recovery by Obesity Status",
       y = "REE (kcal/day)",
       color = "Location",
       fill = "Location") +
  theme_bw() +
  theme(strip.background = element_rect(fill="grey90"),
        strip.text = element_text(size=11))
```

## Model Diagnostics

```{r}
# Residual plots
plot(
  fitted(model_REEperKG),
  resid(model_REEperKG, type = "pearson"),
  pch = 19, col = "black",
  xlab = "Fitted Values",
  ylab = "Pearson Residuals",
  main = "Residuals vs Fitted: REEperKG"
)
abline(h = 0, col = "red", lty = 2, lwd = 2)

plot(
  fitted(model_REE),
  resid(model_REE, type = "pearson"),
  pch = 19, col = "black",
  xlab = "Fitted Values",
  ylab = "Pearson Residuals",
  main = "Residuals vs Fitted: REE"
)
abline(h = 0, col = "red", lty = 2, lwd = 2)

```
```{r}
# QQ plots: residuals
qqnorm(resid(model_REEperKG),
       main = "Q-Q Plot of Residuals: REEperKG",
       pch = 19, col = "black")
qqline(resid(model_REEperKG), col = "red", lwd = 2)

qqnorm(resid(model_REE),
       main = "Q-Q Plot of Residuals: REE",
       pch = 19, col = "black")
qqline(resid(model_REE), col = "red", lwd = 2)


## QQ plots: random effects
re_REEperKG <- ranef(model_REEperKG)$ID[[1]]
re_REE      <- ranef(model_REE)$ID[[1]]

qqnorm(re_REEperKG,
       main = "Q-Q Plot of Random Intercepts: REEperKG",
       pch = 19, col = "black")
qqline(re_REEperKG, col = "red", lwd = 2)

qqnorm(re_REE,
       main = "Q-Q Plot of Random Intercepts: REE",
       pch = 19, col = "black")
qqline(re_REE, col = "red", lwd = 2)
```
```{r}
# REEperKG: Ratio test
model_REEperKG_full_ML <- update(model_REEperKG, REML = FALSE)

## Drop ICU x Measurement
model_REEperKG_no_locInt <- lmer(
  REEperKG ~ Obese * Measurement + ICUorSDU + Measurement + Ventilator + (1 | ID),
  data = REE,
  REML = FALSE
)

## Drop Obese x Measurement
model_REEperKG_no_obInt <- lmer(
  REEperKG ~ Obese + Measurement + ICUorSDU * Measurement + Ventilator + (1 | ID),
  data = REE,
  REML = FALSE
)

## Drop both interactions (main-effects only)
model_REEperKG_main <- lmer(
  REEperKG ~ Obese + Measurement + ICUorSDU + Ventilator + (1 | ID),
  data = REE,
  REML = FALSE
)

## AIC & BIC
AIC(model_REEperKG_full_ML, model_REEperKG_no_locInt, model_REEperKG_no_obInt, model_REEperKG_main)
BIC(model_REEperKG_full_ML, model_REEperKG_no_locInt, model_REEperKG_no_obInt, model_REEperKG_main)

## Likelihood ratio tests
anova(model_REEperKG_full_ML, model_REEperKG_no_locInt)
anova(model_REEperKG_full_ML, model_REEperKG_no_obInt)
anova(model_REEperKG_full_ML, model_REEperKG_main)

```
```{r}
# REE: Ratio test
model_REE_full_ML <- update(model_REE, REML = FALSE)

# Drop ICU x Measurement
model_REE_no_locInt <- lmer(
  REE ~ Obese * Measurement + ICUorSDU + Measurement + Ventilator + (1 | ID),
  data = REE,
  REML = FALSE
)

# Drop Obese x Measurement
model_REE_no_obInt <- lmer(
  REE ~ Obese + Measurement + ICUorSDU * Measurement + Ventilator + (1 | ID),
  data = REE,
  REML = FALSE
)

# Drop both interactions (main-effects only)
model_REE_main <- lmer(
  REE ~ Obese + Measurement + ICUorSDU + Ventilator + (1 | ID),
  data = REE,
  REML = FALSE
)

# AIC & BIC
AIC(model_REE_full_ML, model_REE_no_locInt, model_REE_no_obInt, model_REE_main)
BIC(model_REE_full_ML, model_REE_no_locInt, model_REE_no_obInt, model_REE_main)

# Likelihood ratio tests
anova(model_REE_full_ML, model_REE_no_locInt)
anova(model_REE_full_ML, model_REE_no_obInt)
anova(model_REE_full_ML, model_REE_main)

```
